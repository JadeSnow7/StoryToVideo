# 📚 StoryToVideo 项目文档汇总

> **代码仓库 GitHub 地址：** https://github.com/JadeSnow7/StoryToVideo

---

## 📋 文档导航

| 文档类型 | 说明 |
|----------|------|
| [1. 需求文档 (PRD)](#1-需求文档-prd) | 项目背景、功能需求、非功能需求 |
| [2. 交互设计文档](#2-交互设计文档) | 设计规范、页面流转、交互逻辑 |
| [3. 架构设计文档](#3-架构设计文档) | 总体架构、技术选型、数据流、API规范 |
| [4. 模型部署文档](#4-模型部署与使用文档) | LLM/SD/SVD/TTS 部署与使用 |
| [5. 项目规划](#5-项目规划) | 团队分工、里程碑、每周计划 |
| [6. 项目每日记录](#6-项目每日记录--会议纪要) | 会议纪要、进度跟踪 |

---

# 1. 需求文档 (PRD)

> **版本：** v1.0 | **日期：** 2025.11.17

## 1.1 项目背景与定位

| 项目 | 说明 |
|------|------|
| **项目名称** | StoryToVideo (PC Client) |
| **定位** | 极简"故事到视频"生成项目，强调功能跑通与架构可扩展性 |
| **核心目标** | 19 天内跑通从"输入故事"到"生成视频"的完整技术链路 |
| **目标用户** | 需要快速将文本创意可视化的内容创作者 |
| **运行环境** | Windows / macOS (基于 Qt/QML) |

## 1.2 功能需求 (MVP Scope)

### 核心业务流程

```
1. 新建故事 ──→ 用户输入文本 ──→ AI 分析结构 ──→ 生成分镜列表
2. 分镜编辑 ──→ 用户调整 Prompt ──→ AI 生成静态图 (Keyframe)
3. 视频合成 ──→ 文生图 ──→ 图生视频 ──→ 拼接片段 ──→ 导出 MP4
```

### 详细功能列表

| 功能 | 描述 | 优先级 |
|------|------|--------|
| **F1 新建故事** | 纯文本输入(≤500字)；3+风格预设(电影/二次元/写实)；调用LLM生成；超时/失败可重试 | P0 |
| **F2 故事板管理** | 横向滚动卡片流；缩略图/序号/描述；状态标识(等待/进行/完成/失败)；点击进详情 | P0 |
| **F3 分镜详情** | Prompt/Narration可编辑；"Generate Image"触发SD；转场效果(Crossfade)；状态流转 | P0 |
| **F4 预览与导出** | 顺序播放片段；音量/进度控制；导出MP4(文件对话框+Toast) | P0 |
| **F5 资产库** | 历史项目网格；按标题/时间过滤；hover显示打开/删除 | P1 |

## 1.3 非功能需求

| 类型 | 要求 |
|------|------|
| **响应速度** | UI保持60fps流畅；所有网络请求异步，严禁阻塞UI线程 |
| **数据持久化** | SQLite + 本地文件缓存；无网络时可加载已缓存的项目和图片 |
| **部署架构** | PC客户端 + 云服务端(业务逻辑) + 本地服务器(AI推理/FRP穿透) |

---

# 2. 交互设计文档

## 2.1 设计规范 (Design System)

| 规范项 | 参数 |
|--------|------|
| **分辨率** | 基准 1280×720，自适应 1920×1080 |
| **主题** | 深色模式 (Dark Mode) |
| **背景色** | `#1E1E1E` |
| **主色调** | `#3B82F6` (Tech Blue) |
| **文本色** | `#FFFFFF` (Primary) / `#9CA3AF` (Secondary) |
| **字体** | 微软雅黑 / Roboto |

## 2.2 页面流转图 (User Flow)

```
┌─────────────┐     点击新建      ┌─────────────┐     生成成功      ┌─────────────┐
│   Splash    │ ──────────────→  │   Create    │ ──────────────→  │ Storyboard  │
│   /Login    │                  │  新建故事    │                  │  分镜看板    │
└─────────────┘                  └─────────────┘                  └──────┬──────┘
       │                                                                  │
       │ 自动跳转                                                         │ 点击卡片
       ▼                                                                  ▼
┌─────────────┐     点击历史项目   ┌─────────────┐      返回        ┌─────────────┐
│   Assets    │ ──────────────→  │ Storyboard  │ ←─────────────── │ Shot Detail │
│  资产库/首页 │                  │  分镜看板    │                  │   详情页    │
└─────────────┘                  └──────┬──────┘                  └─────────────┘
                                        │
                                        │ 点击合成视频
                                        ▼
                                 ┌─────────────┐      导出        ┌─────────────┐
                                 │   Preview   │ ──────────────→  │  本地文件    │
                                 │   预览页    │                  │   (.mp4)    │
                                 └─────────────┘                  └─────────────┘
```

## 2.3 详细页面交互逻辑

### Assets (资产库/首页)

| 元素 | 交互说明 |
|------|----------|
| **布局** | 网格布局 (Grid View)，每个 Item 为一个项目封面 |
| **Hover 项目** | 显示"打开"和"删除"图标 |
| **Click "+"** | 跳转至 Create 页面 |
| **Click 项目** | 跳转至 Storyboard 页面 |

### Create (新建页)

| 元素 | 交互说明 |
|------|----------|
| **布局** | 左右分栏：左侧文本输入框，右侧风格选项卡 |
| **Loading 状态** | 点击生成后按钮禁用，显示"正在解析故事结构..." |
| **关键逻辑** | LLM 耗时较长(10s+)，通过 WebSocket 或轮询查询进度 |

### Storyboard (分镜看板)

| 元素 | 交互说明 |
|------|----------|
| **布局** | 底部水平滚动缩略图条(Timeline)，中部主预览区 |
| **横向滚动** | 支持鼠标滚轮横向滚动 |
| **点击卡片** | 选中高亮边框 |
| **双击卡片** | 进入 Shot Detail 页面 |
| **Action Bar** | "生成全部图片"、"合成预览"按钮 |

### Shot Detail (详情页)

| 元素 | 交互说明 |
|------|----------|
| **布局** | 左侧大图预览(50%)，右侧属性编辑区(50%) |
| **未生成** | 显示占位图 + "点击生成"按钮 |
| **生成中** | 图片区域模糊遮罩 + 进度条 |
| **生成完成** | 显示新图，右上角"重新生成"按钮 |

### Preview (预览页)

| 元素 | 交互说明 |
|------|----------|
| **播放控制** | 播放/暂停/进度条/音量 |
| **导出** | 弹出系统文件保存对话框，成功后 Toast 提示 |

---

# 3. 架构设计文档

## 3.1 总体架构图

采用 **Client – Server – Worker（本地算力）** 三层架构，利用 FRP 实现公网服务器对本地 GPU 节点的调用。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端层                                        │
├─────────────────┬─────────────────┬─────────────────────────────────────────┤
│  PC 客户端       │  iOS 客户端      │  Android 客户端                         │
│  (Qt/QML)       │  (SwiftUI)      │  (Kotlin)                               │
└────────┬────────┴────────┬────────┴────────┬────────────────────────────────┘
         │                 │                 │
         └─────────────────┼─────────────────┘
                           │ REST / WebSocket
                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           后端服务层                                         │
├─────────────────┬─────────────────┬─────────────────────────────────────────┤
│  API 服务        │  任务队列        │  模型网关                               │
│  (Go/Gin)       │  (Redis+Asynq)  │  (Model Gateway)                        │
└────────┬────────┴────────┬────────┴────────┬────────────────────────────────┘
         │                 │                 │
         │                 │                 │ FRP Tunnel
         ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           模型服务层 (本地 GPU)                              │
├─────────────────┬─────────────────┬─────────────────┬───────────────────────┤
│  LLM            │  文生图          │  图生视频        │  语音合成             │
│  (Qwen2.5-0.5B) │  (SD Turbo)     │  (SVD)          │  (CosyVoice)          │
└─────────────────┴─────────────────┴─────────────────┴───────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据存储层                                         │
├─────────────────┬─────────────────┬─────────────────┬───────────────────────┤
│  数据库          │  图像存储        │  视频存储        │  语音存储             │
│  (PostgreSQL)   │  (MinIO/TOS)    │  (MinIO/TOS)    │  (MinIO/TOS)          │
└─────────────────┴─────────────────┴─────────────────┴───────────────────────┘
```

## 3.2 模块技术选型

| 层级 | 技术栈 |
|------|--------|
| **客户端 (PC)** | Qt 6.5+ / QML + C++ / FFmpeg / SQLite |
| **服务端 (云端)** | Go Gin / PostgreSQL / Redis + Asynq / MinIO |
| **模型网关** | Python FastAPI |
| **本地模型** | Qwen 0.5B (Ollama) / SD Turbo / SVD Img2Vid / CosyVoice-mini |
| **内网穿透** | FRP (frps 云端, frpc 本地) |

## 3.3 核心数据流（生成分镜图片）

```
① 客户端发起任务
   POST /v1/api/projects/:id/shots/:shot_id/generate
                    │
                    ▼
② 服务端创建任务记录
   写入 Task 表 (status=PENDING) → 推入 Redis 队列
                    │
                    ▼
③ Worker 调度本地模型
   通过 FRP 隧道调用: POST http://gateway:8000/v1/generate
                    │
                    ▼
④ 本地模型计算
   SD Turbo 生成图片 → 保存临时文件
                    │
                    ▼
⑤ 上传到 MinIO
   获取签名 URL: https://minio.xxx/shots/xxx/image.png?signature=...
                    │
                    ▼
⑥ 更新数据库
   Task.status = SUCCESS, Shot.image_path = URL
                    │
                    ▼
⑦ 客户端轮询/WebSocket
   GET /v1/api/tasks/:task_id → 获取结果 → 刷新 UI
```

## 3.4 数据库模型设计

### Project (项目)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | VARCHAR(64) | 主键 |
| title | VARCHAR(255) | 项目标题 |
| story_text | TEXT | 故事文本 |
| style | VARCHAR(50) | 风格 |
| status | VARCHAR(20) | created/processing/completed/failed |
| cover_image | VARCHAR(500) | 封面图 URL |
| video_url | VARCHAR(500) | 最终视频 URL |
| shot_count | INT | 分镜数量 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### Shot (分镜)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | VARCHAR(64) | 主键 |
| project_id | VARCHAR(64) | 关联项目 |
| order | INT | 分镜顺序 |
| title | VARCHAR(255) | 分镜标题 |
| description | TEXT | 分镜描述 |
| prompt | TEXT | 绘画提示词 |
| narration | TEXT | 旁白文本 |
| image_path | VARCHAR(500) | 图片 URL |
| audio_path | VARCHAR(500) | 音频 URL |
| video_url | VARCHAR(500) | 视频片段 URL |
| status | VARCHAR(20) | pending/processing/completed/failed |
| transition | VARCHAR(50) | 转场效果 |

### Task (异步任务)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | VARCHAR(64) | 主键 |
| project_id | VARCHAR(64) | 关联项目 |
| shot_id | VARCHAR(64) | 关联分镜 |
| type | VARCHAR(50) | generate_storyboard/generate_shot/generate_video/generate_audio |
| status | VARCHAR(20) | pending/blocked/processing/finished/failed |
| progress | INT | 进度 0-100 |
| message | TEXT | 状态消息 |
| parameters | JSON | 任务参数 |
| result | JSON | 任务结果 (resource_url 等) |
| error | TEXT | 错误信息 |
| created_at | TIMESTAMP | 创建时间 |

## 3.5 API 接口规范

### 业务 API (服务端)

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/v1/api/projects` | 创建项目 + 自动生成分镜 |
| GET | `/v1/api/projects/:id` | 获取项目详情 |
| GET | `/v1/api/projects/:id/shots` | 获取分镜列表 |
| POST | `/v1/api/projects/:id/shots/:shot_id` | 更新分镜 (prompt/narration/transition) |
| POST | `/v1/api/projects/:id/video` | 触发视频合成 |
| POST | `/v1/api/projects/:id/tts` | 触发 TTS 生成 |
| GET | `/v1/api/tasks/:task_id` | 查询任务状态 |
| DELETE | `/v1/api/projects/:id` | 删除项目 |

### 模型 API (Gateway)

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/llm/storyboard` | 分镜生成 (LLM) |
| POST | `/txt2img/generate` | 文生图 (SD Turbo) |
| POST | `/img2vid/generate` | 图生视频 (SVD) |
| POST | `/tts/narration` | 语音合成 (CosyVoice) |
| GET | `/v1/jobs/:job_id` | 查询任务状态 |

### 请求/响应示例

**创建项目**
```json
// POST /v1/api/projects?Title=xxx&StoryText=xxx&Style=cinematic
// Response:
{
  "project_id": "abc123",
  "text_task_id": "task-text-001",
  "shot_task_ids": ["task-shot-001", "task-shot-002", ...]
}
```

**查询任务状态**
```json
// GET /v1/api/tasks/task-001
// Response:
{
  "task": {
    "id": "task-001",
    "status": "finished",
    "progress": 100,
    "result": {
      "resource_type": "image",
      "resource_url": "https://minio.xxx/shots/xxx/image.png"
    }
  }
}
```

---

# 4. 模型部署与使用文档

> 适用环境：Linux x86_64 / CUDA 12.x / Python 3.10

## 4.1 LLM - 结构化分镜生成 (Qwen2.5-0.5B)

| 项目 | 说明 |
|------|------|
| **模型** | Qwen2.5:0.5b-instruct |
| **框架** | Ollama |
| **接口** | HTTP POST |
| **端口** | 11434 |

**部署步骤**
```bash
# 1. 安装 Ollama
curl -fsSL https://ollama.com/install.sh | sh

# 2. 启动服务
ollama serve

# 3. 拉取模型
ollama pull qwen2.5:0.5b-instruct
```

**使用示例**
```python
import requests

payload = {
    "model": "qwen2.5:0.5b-instruct",
    "messages": [
        {"role": "system", "content": "你是分镜脚本助手，输出 JSON 格式分镜列表"},
        {"role": "user", "content": "故事：一只小猫在雪地里追雪花\n风格：新海诚\n分镜数量：4"}
    ],
    "format": "json",
    "stream": False
}
resp = requests.post("http://localhost:11434/api/chat", json=payload)
print(resp.json())
```

## 4.2 文生图 - SD Turbo

| 项目 | 说明 |
|------|------|
| **模型** | stabilityai/sd-turbo |
| **框架** | diffusers |
| **推理步数** | 2-4 步 |
| **端口** | 8002 |

**安装依赖**
```bash
pip install diffusers transformers accelerate safetensors torch
```

**使用示例**
```python
from diffusers import AutoPipelineForText2Image
import torch

pipe = AutoPipelineForText2Image.from_pretrained(
    "stabilityai/sd-turbo", torch_dtype=torch.float16
).to("cuda")

image = pipe("sunset beach cinematic, anime style", num_inference_steps=4).images[0]
image.save("output.png")
```

## 4.3 图生视频 - SVD Img2Vid

| 项目 | 说明 |
|------|------|
| **模型** | stabilityai/stable-video-diffusion-img2vid |
| **框架** | diffusers |
| **显存需求** | ≥16GB |
| **端口** | 8003 |

**使用示例**
```python
from diffusers import StableVideoDiffusionPipeline
from PIL import Image
import torch, imageio
import numpy as np

pipe = StableVideoDiffusionPipeline.from_pretrained(
    "stabilityai/stable-video-diffusion-img2vid",
    torch_dtype=torch.float16, variant="fp16"
).to("cuda")

image = Image.open("input.png").convert("RGB").resize((576, 1024))
frames = pipe(image, num_frames=14).frames[0]
video = [np.array(f.convert("RGB")) for f in frames]
imageio.mimsave("output.mp4", video, fps=6)
```

## 4.4 语音合成 - CosyVoice

| 项目 | 说明 |
|------|------|
| **模型** | CosyVoice2-0.5B |
| **框架** | 自定义 FastAPI |
| **端口** | 8004 |

**部署步骤**
```bash
# 1. 克隆项目
git clone --recursive https://github.com/FunAudioLLM/CosyVoice.git
cd CosyVoice

# 2. 创建环境
conda create -n cosyvoice python=3.10 -y
conda activate cosyvoice
pip install -r requirements.txt

# 3. 启动服务
cd runtime/python/fastapi
python server.py --model_dir ../../pretrained_models/CosyVoice2-0.5B
```

## 4.5 聚合服务启动

```bash
# 启动网关 (聚合所有模型服务)
cd StoryToVideo
uvicorn gateway.main:app --host 0.0.0.0 --port 8000

# 路由:
# POST /llm/storyboard
# POST /txt2img/generate
# POST /img2vid/generate
# POST /tts/narration
```

---

# 5. 项目规划

## 5.1 团队角色与职责

| 角色 | 职责范围 |
|------|----------|
| **客户端组长 (PC Lead)** | Qt 基建、Create/Storyboard 页面、网络封装 |
| **客户端开发 (PC Media)** | Detail/Preview 页面、FFmpeg/文件处理 |
| **服务端组长 (Server Lead)** | API 接口、数据库、部署运维 |
| **服务端开发 (Server Logic)** | 任务队列、FRP、OSS/MinIO、Webhook |
| **AI 工程师 (LLM/TTS)** | Qwen2.5 分镜生成、Prompt 优化、CosyVoice TTS |
| **AI 工程师 (Visual)** | SD Turbo 文生图、SVD 图生视频、效果调优 |

## 5.2 里程碑计划

| 里程碑 | 日期 | 目标 |
|--------|------|------|
| **M1 基建联调** | 11.23 | 前后端联调，创建项目→返回分镜列表 |
| **M2 核心功能** | 11.30 | 全链路跑通：文本→分镜→图片→视频 |
| **M3 优化交付** | 12.05 | UI 完善、Bug 修复、文档交付、Release |

## 5.3 每周详细计划

### Week 1: 基建与联调 (11.17 - 11.23)

| 模块 | 任务 |
|------|------|
| **Client** | Qt+CMake 工程搭建；QNetwork 封装；Create 页 UI；Assets Mock 列表 |
| **Server** | Go/Gin 部署；PostgreSQL 配置；API 文档；FRP 搭建测试 |
| **AI** | Qwen2.5 分镜 JSON 输出；SD Turbo HTTP 接口；联合调试 |
| **里程碑** | ✅ 点击新建 → DB 生成记录 → 返回分镜列表 |

### Week 2: 核心功能 (11.24 - 11.30)

| 模块 | 任务 |
|------|------|
| **Client** | Storyboard 横滚绑定数据；Shot Detail 异步刷图；视频预览；TTS 接入 |
| **Server** | 任务队列超时/重试；MinIO 上传；Webhook 进度推送 |
| **AI** | Prompt 优化；TTS 部署；SVD 尝试（效果差则回退平移动效） |
| **里程碑** | ✅ 全链路跑通：文本 → 分镜 → 图片 → 视频 |

### Week 3: 优化与交付 (12.01 - 12.05)

| 模块 | 任务 |
|------|------|
| **Client** | UI/Loading/错误态优化；离线缓存；导出稳定 |
| **Server** | 压力测试；FRP 稳定性；日志告警 |
| **AI** | 固化参数；部署手册 |
| **文档** | 技术文档汇总；PPT 制作；录屏演示 |
| **里程碑** | ✅ Release v1.0 + Code Review |

---

# 6. 项目每日记录 & 会议纪要

| 日期 | 主题 | 记录摘要 |
|------|------|----------|
| 11.17 | 项目启动 | PRD 评审、架构设计确认、任务分工 |
| 11.20 | 技术评审 | 确定 Qt+Go+FastAPI 技术栈；FRP 穿透方案 |
| 11.23 | M1 达成 | 前后端联调完成；创建项目→返回分镜列表 ✅ |
| 11.27 | 功能开发 | Storyboard 页面完成；图片生成流程打通 |
| 11.30 | M2 达成 | 全链路跑通：文本→视频 ✅ |
| 12.02 | 功能完善 | UI 优化、错误处理、重试机制 |
| 12.04 | 文档整理 | 技术文档汇总、PPT 制作、录屏演示 |
| 12.05 | 发布 | Release v1.0 🎉 |

---

# 📎 附录

## 技术栈总结

| 层级 | 技术选型 |
|------|----------|
| **客户端** | Qt 6.5+ / QML / C++ / SQLite / FFmpeg |
| **服务端** | Go Gin / PostgreSQL / Redis + Asynq / MinIO |
| **模型网关** | Python FastAPI |
| **AI 模型** | Qwen2.5-0.5B / SD-Turbo / SVD / CosyVoice |
| **部署** | FRP 内网穿透 / Docker |

## 常见问题 (FAQ)

| 问题 | 解答 |
|------|------|
| **文生图失败？** | 检查 GPU 显存、Prompt 合法性、网络连接 |
| **任务卡住？** | 查看 Task.status，检查 Redis 队列和 Worker 日志 |
| **图片无法显示？** | 确认 image_path 格式：完整 URL 无需拼接，相对路径需拼接 API_BASE_URL |
| **如何重试？** | Task.retryable=true 时可直接重试，否则需修改参数 |

---

> 📌 **最后更新：** 2025.12.05 | **维护者：** StoryToVideo Team
