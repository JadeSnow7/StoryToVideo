# 架构设计文档（飞书交付稿）

## 1. 总体架构
- **三层模型**：PC 客户端（Qt/QML） ←→ 云端服务（Django/DRF + 任务队列） ←→ 本地模型节点（FastAPI，经 FRP 暴露）。
- **通信模式**：REST + WebSocket，长任务由队列驱动；WS 推送状态，HTTP 轮询兜底。
- **核心目标**：解耦生成算力与业务网关，保证 UI 流畅、任务可追踪、资源可复用。

## 2. 关键模块
### 客户端（Qt/QML + C++)
- **UI/状态管理**：ViewModel 单向数据流，统一状态枚举 PENDING/RUNNING/SUCCESS/FAILED。
- **网络层**：QNetworkAccessManager + WebSocket；失败自动重试 + 指数退避；任务轮询兜底。
- **媒体能力**：FFmpeg + OpenGL 播放/合成，支持截图、进度控制与 MP4 导出。
- **存储**：SQLite + 文件缓存保存项目、图片、视频；离线可读历史内容。

### 服务端（Django/DRF 或 Gin）
- **API 网关**：鉴权、限流、日志；统一错误码；反向代理静态资源。
- **任务队列**：Celery/RQ，支持超时、重试、幂等，写入 Task 表；完成后触发 Webhook/WS。
- **数据存储**：PostgreSQL/MySQL；对象存储 OSS/TOS 保存图片/音频/视频；可选 CDN 加速。

### 模型节点（FastAPI）
- **LLM（Qwen2.5-0.5B/Ollama）**：分镜 JSON 与旁白生成。
- **T2I（SD Turbo）**：根据 Prompt 输出关键帧图片。
- **I2V（SVD Img2Vid，可选）**：将图片转短视频片段。
- **TTS（CosyVoice-mini）**：生成旁白音频。
- **FRP**：frpc 将本地端口暴露给云端任务 Worker，保证内网 GPU 可用。

## 3. 数据与 API 设计
- **数据模型**：
  - Project(id, title, style, created_at)
  - Shot(id, project_id, order, prompt, narration, image_url, video_url, status)
  - Task(id, type, payload, status, result_data, err_msg)
- **API 核心路由**：
  - POST `/api/projects/create`：创建项目并返回分镜列表。
  - GET `/api/projects/{id}/storyboard`：获取分镜数据。
  - POST `/api/shots/{id}/update_prompt`：更新 Prompt/旁白。
  - POST `/api/shots/{id}/generate_image`：触发图片生成任务。
  - POST `/api/shots/{id}/generate_video`（可选）：触发视频生成。
  - GET `/api/tasks/{task_id}/status`：查询任务状态。
  - POST `/api/webhook/task_complete`：模型节点回调写入结果。

## 4. 关键流程示意
1) **分镜生成**：客户端提交故事 → 网关写入 Project+Shot → 任务入队调用 LLM → 写回分镜 JSON → WS 推送前端刷新。
2) **图片生成**：客户端调用 generate_image → 任务入队 → Worker 通过 FRP 调用 SD Turbo → 上传 OSS → 回调任务 SUCCESS → WS/轮询更新 URL。
3) **视频合成与导出**：客户端请求合成 → 任务队列调 FFmpeg 拼接（可叠加旁白）→ 成功后提供下载/本地保存路径。

## 5. 部署与运维
- **环境**：云端 Ubuntu 22.04，Python 3.10+；Nginx+Gunicorn 部署后端；PostgreSQL + Redis；本地 GPU 节点通过 FRP 联通。
- **可观察性**：Prometheus + Grafana 指标，Sentry 捕获异常，结构化日志输出（TraceID 贯穿任务）。
- **安全**：HTTPS、JWT/Token 鉴权；OSS 资源带签名；任务接口限流；敏感配置使用环境变量/密钥管理。

## 6. 风险与缓解
- **生成耗时波动**：通过任务队列超时+重试、WS+轮询双通道反馈。
- **模型不可用**：备用 Mock 服务/降级提示；支持切换到云端备份算力。
- **大文件传输**：采用分段上传至 OSS，返回 CDN URL，客户端异步加载。
