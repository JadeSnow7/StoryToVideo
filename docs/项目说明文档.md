# StoryToVideo 项目说明（标准版）

适用对象：
- 客户端工程（iOS / Android / macOS / Qt）
- 系统工程 / 服务端
- AIGC / 多模态系统项目

文档目标：
- 让陌生工程师 30 分钟内理解项目
- 让新同学 1 天内可以开始改代码
- 让项目在多人协作下不失控

## 1. 项目总览（Overview）

### 1.1 项目背景
- 目标是把“文本故事 → 分镜 → 素材 → 合成视频”跑通为可复用链路。
- 模型推理资源通常在本地 GPU 或专用节点，客户端不宜直连模型端。
- 需要一个稳定的任务编排与状态管理层，保证长耗时任务可追踪、可恢复。

### 1.2 项目目标
核心目标：
- 打通端到端生成链路（故事 → 分镜 → 图片/音频 → 成片）。
- 客户端可编辑分镜并查看进度，生成过程 UI 不阻塞。
- 服务端可管理任务状态，模型调用与业务 API 解耦。

非目标：
- 不追求模型算法最优与 SOTA 画质。
- 不建设多租户计费/权限体系（当前版本）。
- 不覆盖全量移动端生产级能力（可按计划扩展）。

### 1.3 项目里程碑
| 阶段 | 目标 | 负责人 | 时间 |
| --- | --- | --- | --- |
| MVP | 端到端链路跑通，客户端可预览导出 | TBD | 2025.11 |
| Beta | 稳定性与错误态补齐，任务状态完整 | TBD | 2025.11-2025.12 |
| Release | 文档与演示材料完善 | TBD | 2025.12 |

## 2. 系统架构设计（Architecture）

### 2.1 整体架构图
```
[Client (Qt/QML, iOS planned)]
          |
          | REST / WebSocket
          v
[Go Server (Gin)]
   |        |          |
   |        |          +--> [MinIO]
   |        +-------------> [Redis + Asynq]
   +----------------------> [MySQL]
          |
          | HTTP /v1/generate, /v1/jobs
          v
[Gateway/Worker (FastAPI)]
          |
          | HTTP
          v
[Model Services: LLM / txt2img / img2vid / TTS]
```
说明：
- 推荐单机部署（`docker-compose.yml`），Gateway/Model 与 Server 同机运行。
- 如需使用第三方模型/云 API，可通过 `.env.cloud.example` 配置 `LLM_PROVIDER/IMAGE_PROVIDER/TTS_PROVIDER`。

### 2.2 模块职责划分
| 模块 | 职责 | 不负责什么 |
| --- | --- | --- |
| Client | UI、状态展示、分镜编辑、媒体预览 | 模型推理与任务调度 |
| Go Server | 业务 API、任务创建、状态落库、队列调度 | 模型推理与素材合成 |
| Gateway/Worker | 任务编排、模型调用、结果回传 | 用户/项目业务逻辑 |
| Model Services | 推理执行（LLM/T2I/I2V/TTS） | 任务管理与状态持久化 |
| Storage | MySQL/Redis/MinIO 持久化 | 业务逻辑与计算 |

### 2.3 数据流 & 控制流
1) Client 调用 `POST /v1/api/projects` 创建项目并生成任务。  
2) Go Server 写入 Project/Task，并将 Task 投递至 Redis + Asynq。  
3) Processor 调用 Gateway `/v1/generate` 创建模型任务。  
4) Gateway 调用模型服务完成推理，落盘或上传 MinIO。  
5) Processor 轮询 `/v1/jobs/{id}` 更新任务状态与结果。  
6) Server 通过 WebSocket 推送任务进度，Client 更新 UI。  

## 3. 关键设计决策（Design Decisions）

### 3.1 技术选型
| 选型点 | 方案 | 原因 |
| --- | --- | --- |
| 客户端 | Qt/QML + C++ | 跨平台、成熟 UI 能力 |
| 服务端 | Go + Gin + GORM | 性能好、上手快、结构清晰 |
| 任务队列 | Redis + Asynq | 轻量、易部署、适合异步任务 |
| 数据库 | MySQL | 现有配置与镜像易用 |
| 对象存储 | MinIO | 本地/云均可用，S3 兼容 |
| 编排层 | FastAPI Gateway | Python 生态模型调用便利 |
| 通信 | HTTP JSON + WebSocket | 易调试，WS 做进度推送 |

### 3.2 关键权衡（Trade-off）
- 保留 Go Server + Gateway 双层后端，增加部署复杂度，但明确分离业务与模型编排。
- 使用 HTTP + 轮询/WS，放弃 gRPC 或消息总线，换取调试与联调效率。
- 模型侧支持本地 GPU/云 Provider 混用，牺牲一致性换取可用性。

## 4. 接口与协议设计（API & Protocol）

### 4.1 接口总览
Client → Server（对外）：
| 接口 | 方法 | 描述 |
| --- | --- | --- |
| `/v1/api/health` | GET | 健康检查 |
| `/v1/api/projects` | POST | 创建项目（Query 参数） |
| `/v1/api/projects/:project_id` | GET/PUT/DELETE | 项目详情/更新/删除 |
| `/v1/api/projects/:project_id/shots` | GET | 分镜列表 |
| `/v1/api/projects/:project_id/shots/:shot_id` | POST | 更新分镜并触发生成（Query 参数） |
| `/v1/api/projects/:project_id/shots/:shot_id` | GET | 分镜详情 |
| `/v1/api/shots/:shot_id` | DELETE | 删除分镜 |
| `/v1/api/projects/:project_id/video` | POST | 生成视频 |
| `/v1/api/projects/:project_id/tts` | POST | 生成项目 TTS |
| `/v1/api/tasks/:task_id` | GET | 任务状态 |
| `/tasks/:task_id/wss` | GET | WebSocket 进度推送 |

Server → Gateway（内部）：
| 接口 | 方法 | 描述 |
| --- | --- | --- |
| `/v1/generate` | POST | 创建模型任务 |
| `/v1/jobs/{job_id}` | GET | 查询模型任务状态 |
| `/v1/jobs/{job_id}` | DELETE | 取消模型任务 |

### 4.2 请求 / 响应示例
创建项目（Query 参数）：
```
POST /v1/api/projects?Title=demo&StoryText=一只猫在窗边&Style=电影&ShotCount=4
```
响应：
```json
{
  "project_id": "p_123",
  "text_task_id": "t_1",
  "shot_task_ids": ["t_2", "t_3", "t_4", "t_5"]
}
```

更新分镜并触发生成（Query 参数）：
```
POST /v1/api/projects/{project_id}/shots/{shot_id}?prompt=new+prompt&transition=cut
```
响应：
```json
{
  "shot_id": "s_1",
  "task_id": "t_20",
  "message": "分镜已更新并创建生成任务"
}
```

任务状态（REST）：
```json
{
  "task": {
    "id": "t_20",
    "projectId": "p_123",
    "type": "generate_shot",
    "status": "processing",
    "progress": 45,
    "message": "generating image"
  }
}
```

### 4.3 错误码规范
当前仅使用 HTTP Status + `error` 字段：
| Code | 含义 | 处理建议 |
| --- | --- | --- |
| 400 | 参数错误 | 客户端校验与重试 |
| 404 | 资源不存在 | 提示用户或刷新列表 |
| 500 | 内部错误 | 记录日志并重试 |

## 5. 状态机与任务模型（State Machine）

### 5.1 任务状态定义
状态枚举：`pending | blocked | processing | finished | failed | cancelled`

状态流转（简化）：
```
blocked -> pending -> processing -> finished
                     |-> failed
pending/processing -> cancelled
```
说明：
- 创建项目后，分镜生成任务默认 `blocked`，依赖文本任务完成后解锁。
- 任务状态以 `server/internal/models/task.go` 为准。

### 5.2 幂等与重试
- `task_id` 由服务端生成 UUID，不支持基于相同请求的幂等复用。
- Asynq 配置 `MaxRetry=3`、`Timeout=20min`（见 `server/internal/service/queue.go`）。
- 分镜更新会主动取消正在处理的任务并创建新任务。

## 6. 客户端设计（Client Design）

### 6.1 UI 架构
Qt 客户端（已实现）：
- QML 页面：Assets / Create / Storyboard / Shot Detail / Preview
- ViewModel 单向数据流 + NetworkManager（REST/WS）
- SQLite + 文件缓存；FFmpeg + OpenGL 播放与导出

iOS 客户端（规划）：
- SwiftUI + MVVM + APIClient
- 任务状态映射与本地缓存详见 `docs/IOS_CLIENT_PLAN.md`

### 6.2 性能与流畅度
- UI 主线程仅做渲染；网络与任务处理异步。
- 长耗时任务优先 WS 推送，轮询兜底。
- 图片/视频使用本地缓存与 URL cache-bust 防止旧资源。

## 7. 稳定性与异常处理（Stability）

### 7.1 异常场景
- 模型端推理失败或超时。
- 网络抖动导致任务状态获取中断。
- 客户端中断或后台切换导致状态不同步。
- 服务端重启导致任务处于中间状态。

### 7.2 兜底策略
- 队列自动重试（Asynq），失败写入 `failed` 并记录错误。
- WS 失败时切换到轮询 `/v1/api/tasks/:task_id`。
- 重启时将遗留 `pending/processing` 标记为 `cancelled`（processor 启动清理）。
- 模型参数降级（分辨率/步数/帧率）由运维侧控制。

## 8. 开发规范（Coding & Collaboration）

### 8.1 代码规范
- 参考 `docs/CODING_STANDARD.md`（命名规则、格式化、状态枚举）。
- JSON 字段统一 `lowerCamelCase`，避免混用 `snake_case`。

### 8.2 分支策略
- 当前仅 `main` 分支。
- 建议协作采用 `main / dev / feature/*`，并通过 PR 合并。

## 9. 测试与验证（Testing）

### 9.1 单元测试
- iOS：`ios/StoryToVideo/Tests/StoryToVideoTests.swift`。
- 服务端/网关：当前测试覆盖有限，建议补充 Go/Python 单测。

### 9.2 联调与回归
建议最小回归路径：
1) `GET /v1/api/health`
2) 创建项目 → 获取分镜列表
3) 更新分镜 → 查询任务状态 → WS 推送
4) 生成视频 / TTS

联调脚本与启动指南参考：
- `docs/three-tier-startup-api.md`
- `docs/deploy.md`

## 10. 部署与运维（Deploy & Ops）

启动方式（单机 Docker）：
- 编排：`docker-compose.yml`（全栈）
- 脚本：`deploy-server.sh`
- 环境变量：复制 `.env.cloud.example` → `.env`
- 依赖：宿主机 Ollama（默认 `11434`）

配置管理：
- Server：`server/config/config.docker.yaml`
- Gateway/Model：`.env`（`OLLAMA_HOST`、`SVD_ENABLED`、`IMG2VID_*` 等）

日志：
- Server：stdout/log 文件
- Gateway/Model：uvicorn 日志
- 运维建议见 `docs/ops.md`

## 11. 已知问题 & 技术债
- 客户端图片缓存导致重生成后不刷新（需 cache-bust 或重新拉取）。
- `UpdateShot` 目前读取 Query 参数，客户端若发送 JSON 会不生效。
- API Base URL 在客户端存在混用，资源 URL 可能指向错误主机。
- 首批分镜任务轮询未自动启动（需补齐任务订阅逻辑）。
- 视频预览路径仍使用示例占位。
- JSON 字段命名存在 camelCase/snake_case 混用问题。
- TTS 接口当前使用默认参数，忽略请求体。

## 12. 附录

名词解释：
- LLM：大语言模型，用于分镜生成
- T2I：Text-to-Image（文生图）
- I2V：Image-to-Video（图生视频）
- TTS：Text-to-Speech（语音合成）
- Asynq：基于 Redis 的任务队列
- MinIO：S3 兼容对象存储

参考文档：
- `docs/ARCHITECTURE.md`
- `docs/PRD.md`
- `docs/MILESTONES.md`
- `docs/apis.md`
- `docs/pipeline.md`
- `docs/deploy.md`
- `docs/ops.md`
- `docs/IOS_CLIENT_PLAN.md`
- `docs/three-tier-startup-api.md`
